<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>“Activity killed by system“</title>
  <meta name="description" content="Coding in Android is not difficult. But sometimes if you don’t understand how Android works it may fail you and you have no idea what is going on. ">

  <link rel="canonical" href="/android/dev/2015/10/11/activity-killed-by-system.html">
  <link rel="alternate" type="application/rss+xml" title="" href="/feed.xml" />

  <!-- Material Design Lite css Library -->
  <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.indigo-pink.min.css">
  
  <!-- Material Design Fonts -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- Custom theme css -->
  <link rel="stylesheet" href="/css/main.css">
</head>


  <body>

    <!-- Start Layout -->
    
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <!-- search layout -->
<div class="super-search" id="js-search">
  <ul class="super-search__results" id="js-search__results"></ul>        
  <button class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored super-search__close-btn" onclick="superSearch.toggle()">
    <i class="material-icons">close</i>
  </button>
</div>
<!-- /end search -->
        <header class="mdl-layout__header">

    <div class="mdl-layout__header-row">
      <!-- Title -->
      <span class="mdl-layout-title"></span>
      <!-- Add spacer, to align navigation to the right -->
      <div class="mdl-layout-spacer"></div>
      

      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable is-upgraded">
        <label class="mdl-button mdl-js-button mdl-button--icon" for="js-search__input">
          <i class="material-icons">search</i>
        </label>

        <div class="mdl-textfield__expandable-holder" >
          <input class="mdl-textfield__input super-search__input" type="text" id="js-search__input" />
        </div>
      </div>

      <button class="mdl-button mdl-js-button mdl-button--icon" id="menu-lower-left">
        <i class="material-icons">more_vert</i>
      </button>

      <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="menu-lower-left">
        
      </ul>
    </div>
  </header>

  <div class="mdl-layout__drawer">
    <span class="mdl-layout-title">Menu</span>
    <nav class="mdl-navigation">
    
      
      <a class="mdl-navigation__link" href="/about/">About</a>
      
    
      
    
      
    
      
    
    </nav>

  </div>


    

      <main class="mdl-layout__content">
        <div class="post-ribbon"></div>
<main class="post-main mdl-layout__content">
  <div class="post-container mdl-grid">
    <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
    <div class="post-section mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col">
      <div class="mdl-color-text--grey-500">
      Oct 11, 2015 •  android  dev  
      </div>
      <h3>“Activity killed by system“</h3>
      <article class="post-content">
        <p><p>Coding in Android is not difficult. But sometimes if you don’t understand how Android works it may fail you and you have no idea what is going on. </p>

<p>Recently I encounted with this exception with Fragment:</p>

<blockquote>
  <p>java.lang.IllegalStateException: Can not perform this action after onSaveInstanceState</p>
</blockquote>

<p>It turns out that somehow, when I launch this Activity, system kills it immediately and restart it again. And I have a thread to load data before it’s displayed in fragment. Notice that when Activity is destroied, the thread is still running, as a result of which, it has a reference of this Activity. It still tries to add this fragment in this old Activity (which is supposed to be destroied). There it goes wrong. </p>

<p>The code is simplified as follow:</p>

<pre><code>//in onCreate()
new Handler().postDelayed(new Runnable() {
    @Override
    public void run() {
        Fragment fragment = new MainFragment();
        getSupportFragmentManager().beginTransaction()
            .replace(R.id.main_content, fragment)
            .commit();
    }
}, 5000);
</code></pre>

<p>Therefore, the solution is quite simple, set a flag as true only after onDestroy() is called, then you won’t want to add this fragment when it’s true, like this:</p>

<pre><code>@Override
protected void onDestroy() {
    super.onDestroy();
    isDestroyed = true;
}
//in onCreate()
new Handler().postDelayed(new Runnable() {
    @Override
    public void run() {
        if(flag) return;
        ...
    }
}, 5000);
</code></pre>

<p>It looks fine now, but there’s another problem. onCreate() in Fragment is called twice. 
That’s because Activity cashes fragments itself. That’s simple, cause Fragment has its own onSaveInstanceState, if Activity doesn’t cache it, how it’s supposed to call onSaveInstanceState? Therefore, the solution is as simple as this:</p>

<pre><code>@Override
protected void onCreate(Bundle savedInstanceState) {
	new Handler().postDelayed(new Runnable() {
        @Override
        public void run() {
            addFragment(savedInstanceState == null);
        }
    }, 5000);
...
private void addFragment(boolean isNull){
    Fragment fragment = null;
    if(isNull){
        fragment = new MainFragment();
    }else{
        fragment = getSupportFragmentManager().findFragmentByTag("fragment");
    }
    getSupportFragmentManager().beginTransaction()
            .replace(R.id.main_content, fragment, "fragment")
            .commit();
}
</code></pre>
</p>
      </article>
    </div>
  </div>
</main>

        <footer class="mdl-mega-footer">
  <div class="mdl-mega-footer--middle-section">

    <div class="mdl-mega-footer--drop-down-section">
      <input class="mdl-mega-footer--heading-checkbox" type="checkbox" checked>
      <h1 class="mdl-mega-footer--heading">INFO</h1>
      <ul class="mdl-mega-footer--link-list">
        <li><a href="mailto:"></a></li>
        <li><a href="/feed.xml">subscribe via RSS</a></li>
      </ul>
    </div>

    <div class="mdl-mega-footer--drop-down-section">
      <input class="mdl-mega-footer--heading-checkbox" type="checkbox" checked>
      <h1 class="mdl-mega-footer--heading">SOCIAL</h1>
      <ul class="mdl-mega-footer--link-list">
        
        
      </ul>
    </div>

    <div class="mdl-mega-footer--drop-down-section">
      <input class="mdl-mega-footer--heading-checkbox" type="checkbox" checked>
      <h1 class="mdl-mega-footer--heading">ABOUT</h1>
      <ul class="mdl-mega-footer--link-list">
        <li></li>
      </ul>
    </div>


  </div>

  <div class="mdl-mega-footer--bottom-section">
    <div class="mdl-logo"></div>
    <ul class="mdl-mega-footer--link-list">
      <li><a href="#">Help</a></li>
      <li><a href="#">Privacy & Terms</a></li>
    </ul>
  </div>

</footer>

      </main>

    </div>
    <!-- /End Layout -->

    <!-- Material Design Lite js Library -->
    <script type="text/javascript" src="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.min.js"></script>
    
    <script rel="javascript" type="text/javascript" src="/js/search.js"></script>
    <script rel="javascript" type="text/javascript">
      superSearch({
        searchFile: '/feed.xml',
        searchSelector: '#js-search', // CSS Selector for search container element.
        inputSelector: '#js-search__input', // CSS selector for <input>
        resultsSelector: '#js-search__results' // CSS selector for results container
      });
    </script>
  </body>

</html>
